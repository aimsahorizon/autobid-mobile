================================================================================
AUTOBID MOBILE - COMPLETE IMPLEMENTATION REFERENCE
================================================================================
Version: 2.0 - Fresh Database Start
Date: 2025-12-07
Purpose: Complete reference for database schema implementation
================================================================================

This directory contains comprehensive documentation for rebuilding the AutoBid
Mobile database from scratch with proper 3NF normalization, encryption, and
admin functionality.

================================================================================
REFERENCE DOCUMENTS
================================================================================

1. database_schema.txt (Primary Reference - 1,980 lines)
   Purpose: Complete 3NF normalized database schema
   Contents:
   - 51 total tables (35 application + 16 admin)
   - 6 storage buckets
   - 30+ RPC functions
   - 2 materialized views
   - All column definitions with constraints
   - All foreign key relationships
   - Index strategy
   - RLS policies
   - Triggers and automation
   - Migration notes from current schema

2. data_encryption_guidelines.txt (Security Reference - 1,200+ lines)
   Purpose: Professional encryption implementation guide
   Contents:
   - 3-layer encryption strategy
   - Field-by-field encryption classification
   - Supabase Vault implementation (national IDs)
   - pgcrypto implementation (phone, DOB)
   - Application-level file encryption (KYC photos)
   - Key management and rotation
   - RLS policies for encrypted data
   - Compliance (GDPR, Philippine Data Privacy Act)
   - Audit logging for encryption access
   - Performance considerations
   - Testing and validation

3. admin_system_requirements.txt (Admin Module Reference - 1,400+ lines)
   Purpose: Complete admin functionality specification
   Contents:
   - 5 admin roles (super_admin, operations_admin, finance_admin, support_admin, moderator)
   - Permission matrix (RBAC)
   - Dashboard with real-time metrics
   - KYC review system (document viewer, verification tools)
   - Auction live monitoring (final 2-minute alerts, snipe guard tracking)
   - Financial management (payment verification, refunds, token packages)
   - User management (profile editing, suspension, impersonation)
   - Support ticket system (SLA tracking, templates, auto-assignments)
   - Content moderation (listing review, AI detection)
   - Dispute resolution
   - System settings and configuration
   - Audit log and activity tracking
   - Notification center (real-time alerts, daily/weekly digests)

================================================================================
SCHEMA OVERVIEW
================================================================================

SECTION 1: AUTHENTICATION & USER MANAGEMENT
Tables: auth.users, addresses, users
Key Features:
- Normalized addresses (3NF) for city/province/region hierarchy
- KYC fields with encrypted sensitive data
- Account status workflow (pending → under_review → approved/rejected/suspended)
- Encrypted: national_id_number, secondary_gov_id_number (Supabase Vault)
- Encrypted: phone_number, date_of_birth (pgcrypto)
- Encrypted files: National ID photos, secondary ID photos, selfie with ID, proof of address

SECTION 2: VEHICLE & LISTING MASTER DATA (3NF)
Tables: car_brands, car_models, listing_drafts, listing_photos, listing_documents, listing_features
Key Features:
- Normalized car brands → models hierarchy
- Separate photos (listing_photos) vs documents (listing_documents)
- listing_features table (eliminates TEXT[] arrays for 1NF)
- 9-step listing creation process
- AI fields: ai_suggested_keywords, ai_suggested_starting_price, ai_suggested_reserve_price
- Vehicle history: insurance_status, maintenance_history, damage_history, past_condition, current_condition

SECTION 3: AUCTION & BIDDING (Thesis Enhancements)
Tables: auctions, auction_participants, bids, auction_deposits, watchlist, auction_questions
Key Features:
- bidding_type: 'public' | 'private' (private requires participants table)
- minimum_bid_increment (configurable per auction)
- snipe_guard_seconds (default 30s, extends timer if bid placed near end)
- allow_rebid (2nd highest can match winning bid)
- offer_to_next_bidder (if winner backs out)
- Bid status management: 'active' | 'outbid' | 'winning' | 'won' | 'lost' | 'cancelled'
- Auto-bidding support (max_bid tracking)

SECTION 4: TRANSACTION SYSTEM
Tables: transactions, transaction_forms, transaction_messages, transaction_timeline
Key Features:
- Buyer-seller transaction workflow
- Form submissions (buyer/seller)
- Real-time chat (transaction_messages with Supabase Realtime)
- Timeline tracking (milestones, status changes)
- Delivery tracking
- Deed of sale document generation

SECTION 5: PAYMENT & TOKEN SYSTEM
Tables: user_token_balances, user_subscriptions, token_packages, token_transactions, payment_transactions
Key Features:
- Token economy (5 tokens per listing, 1 token per bid)
- Token packages with volume discounts
- Payment verification workflow (admin approval)
- Refund processing
- Multiple payment methods (GCash, PayMaya, Bank, Credit Card)

SECTION 6: SUPPORT SYSTEM
Tables: support_categories, support_tickets, support_ticket_messages, support_ticket_attachments
Key Features:
- Hierarchical categories (parent-child)
- Ticket assignment to admins
- SLA tracking (response time, resolution time)
- File attachments support
- Predefined response templates

SECTION 7: NOTIFICATIONS
Tables: notifications
Key Features:
- User notifications for auctions, bids, transactions
- Real-time delivery via Supabase Realtime
- Push notification support (token tracking)
- Email/SMS integration

SECTION 8: AI FEATURES (Thesis Enhancement)
Tables: ai_photo_analysis, ai_price_recommendations
Key Features:
- Photo-based keyword extraction
- Auto-fill vehicle data from photo OCR
- Starting/reserve price recommendations based on condition
- Confidence scoring

SECTION 9: ADMIN SYSTEM (16 Tables)
Tables: admin_roles, admin_permissions, admin_role_permissions, admin_users, admin_sessions,
        admin_audit_log, admin_auction_monitoring, admin_kyc_review_queue,
        admin_payment_verification_queue, admin_notifications, admin_dashboard_metrics,
        admin_reports, encryption_keys, encryption_audit_log, system_settings, admin_activity_summary

Key Features:
- 2 admin roles: Super Admin (full access), Moderator (limited to auction monitoring)
- Role-based access control (RBAC) with granular permissions
- Real-time auction monitoring with final 2-minute alerts
- KYC review queue with SLA tracking (auto-priority after 7 days)
- Payment verification queue with 24-hour SLA
- Dashboard metrics cached and refreshed every 30 seconds
- Admin audit log (7-year retention, partitioned by month)
- Encryption audit log (tracks all access to sensitive data)
- System settings (configurable platform parameters)
- Report generation (PDF, CSV, Excel) with 30-day retention

================================================================================
NORMALIZATION IMPROVEMENTS
================================================================================

FROM CURRENT SCHEMA (1.5NF) → TO 3NF:

1. First Normal Form (1NF) Violations Fixed:
   - photo_urls JSONB → listing_photos table (one photo per row)
   - features TEXT[] → listing_features table (one feature per row)
   - Repeating groups eliminated

2. Third Normal Form (3NF) Violations Fixed:
   - Address denormalization → addresses table (street, barangay, city, province, region)
   - Car brand/model denormalization → car_brands + car_models tables
   - Transitive dependencies eliminated

3. Consolidation:
   - vehicles + listings + auctions → Merged redundant tables
   - users + user_profiles → Single users table
   - Duplicate bids table definitions → Consolidated

4. Strategic Denormalization for Performance:
   - bid_count, active_bidders_count → Cached in auctions table (updated via triggers)
   - token_balance → Cached in user_token_balances (updated via triggers)
   - Materialized views for reporting (auction_stats_by_category, user_activity_summary)

================================================================================
ENCRYPTION STRATEGY
================================================================================

HIGH PRIORITY - Supabase Vault (AES-256, managed keys):
- national_id_number
- secondary_gov_id_number
Access: Via RPC functions with RLS enforcement, audit logging

MEDIUM PRIORITY - pgcrypto Extension (searchable encrypted):
- phone_number (stored as bytea + hash for lookup)
- date_of_birth (stored as bytea + birth_year for age calculation)
Access: Decrypt via RPC functions, hash for exact match searches

FILE ENCRYPTION - Application-level AES-256-GCM:
- National ID photos (front/back)
- Secondary ID photos (front/back)
- Selfie with ID photo
- Proof of address document
Access: Encrypt before upload, decrypt on download, user-specific keys

KEY MANAGEMENT:
- Master encryption key stored in Supabase environment secrets
- User-specific keys derived from master key + user ID
- Key rotation support with versioning (encryption_keys table)
- Annual rotation recommended

COMPLIANCE:
- Philippine Data Privacy Act 2012 (Section 20 - Security measures)
- GDPR Article 32 (Encryption of personal data)
- Audit logging for all encryption/decryption access
- 7-year retention for audit logs

================================================================================
ADMIN ROLE PERMISSIONS
================================================================================

SUPER_ADMIN (Full System Access):
- User management (create/delete admins and moderators)
- KYC review and approval (kyc.review, kyc.approve permissions)
- Auction monitoring and management (auction.monitor, auction.cancel)
- Payment verification and refunds (payment.verify, payment.refund)
- User support tickets (support.view, support.reply)
- Content moderation (listings, messages)
- Dispute resolution
- Financial reports and analytics (reports.financial)
- Token package management
- System configuration (system_settings table)
- Database management
- Audit log access (audit.view)
- Admin user creation

MODERATOR (Limited Access - Auction Monitoring Only):
- Dashboard view (dashboard.view)
- Auction monitoring (auction.monitor - real-time)
- Flag suspicious auctions (auction.flag)
- Content review (listings/descriptions)
- Monitor Q&A and transaction chats (read-only)
- Limited read-only access to auction data

================================================================================
REAL-TIME FEATURES (Supabase Realtime)
================================================================================

1. Auction Bidding (auctions table, bids table):
   - New bid placed → Update current_highest_bid, bid_count
   - Subscribe: WHERE auction_id = :auction_id
   - Update UI instantly for all watchers

2. Transaction Chat (transaction_messages table):
   - New message → Notify buyer and seller
   - Subscribe: WHERE transaction_id = :transaction_id
   - Real-time chat experience

3. Admin Auction Monitoring (admin_auction_monitoring table):
   - time_remaining_seconds updated every 10 seconds
   - is_final_two_minutes = true → Trigger admin notification
   - Subscribe: WHERE is_final_two_minutes = true OR is_flagged = true

4. Admin Notifications (admin_notifications table):
   - New notification → Push to admin dashboard
   - Subscribe: WHERE admin_id = :admin_id AND is_read = false

5. User Notifications (notifications table):
   - Auction win, outbid, transaction updates
   - Subscribe: WHERE user_id = :user_id AND is_read = false

================================================================================
TRIGGERS & AUTOMATION
================================================================================

1. auto_update_updated_at:
   - Applied to all tables with updated_at column
   - Automatically sets updated_at = now() on UPDATE

2. Denormalized Counter Maintenance:
   - auctions.bid_count → Increment on bids INSERT
   - auctions.active_bidders_count → Recalculate on bids INSERT/UPDATE
   - user_token_balances.balance → Update on token_transactions INSERT

3. KYC Queue Auto-Priority:
   - admin_kyc_review_queue.priority → Set to 'high' if days_pending > 7
   - admin_kyc_review_queue.sla_breached → Set to true if days_pending > 2

4. Payment Queue SLA:
   - admin_payment_verification_queue.sla_breached → Set to true if hours_pending > 24

5. Auction Monitoring:
   - admin_auction_monitoring → Auto-create row when auction starts
   - time_remaining_seconds → Updated every 10 seconds via scheduled function
   - is_final_two_minutes → Set to true when time_remaining_seconds < 120

6. Admin Notifications:
   - Final 2 minutes → Create admin_notifications row for all moderators
   - KYC queue > 50 → Create warning notification
   - Payment pending > 24 hours → Create warning notification

7. Soft Delete:
   - deleted_at timestamp → Set on DELETE (if soft delete enabled)
   - Partial indexes: WHERE deleted_at IS NULL

8. Audit Logging:
   - Trigger on vault.decrypted_secrets access → Log to encryption_audit_log
   - Trigger on admin actions → Log to admin_audit_log

================================================================================
ROW LEVEL SECURITY (RLS) POLICIES
================================================================================

PRINCIPLE: Default deny, explicit allow

1. users table:
   - SELECT: User can view own profile OR admin with user.view permission
   - UPDATE: User can update own profile (non-KYC fields) OR admin with user.edit
   - DELETE: Admin with user.delete permission only

2. auctions table:
   - SELECT: Public if bidding_type = 'public', OR user is participant if 'private'
   - INSERT: User with approved KYC status and sufficient tokens
   - UPDATE: Seller can edit own auctions (if status = 'draft')
   - DELETE: Seller can delete own drafts OR admin with auction.cancel

3. bids table:
   - SELECT: User can view own bids, OR seller can view bids on their auction, OR admin
   - INSERT: User with approved KYC, sufficient tokens, auction is active
   - UPDATE: Not allowed (bids are immutable)
   - DELETE: Admin only (for fraud/violations)

4. transactions table:
   - SELECT: Buyer OR Seller OR admin with relevant permission
   - INSERT: System only (auto-created when auction ends)
   - UPDATE: Buyer/Seller (status updates, form submissions)
   - DELETE: Admin only

5. support_tickets table:
   - SELECT: Ticket creator OR assigned admin OR admin with support.view
   - INSERT: Any authenticated user
   - UPDATE: Assigned admin OR admin with support.reply
   - DELETE: Admin with support.delete

6. admin_users table:
   - SELECT: All admins can view other admins
   - INSERT: Super_admin only
   - UPDATE: Super_admin only (or admin can update own profile)
   - DELETE: Super_admin only

7. admin_audit_log table:
   - SELECT: Super_admin only
   - INSERT: System only (via triggers)
   - UPDATE: Not allowed (immutable)
   - DELETE: Not allowed (7-year retention)

8. vault.decrypted_secrets:
   - SELECT: User can access own secrets OR admin with kyc.review permission
   - Enforced via RPC functions with RLS checks

9. Storage Buckets:
   kyc-documents:
   - INSERT: User can upload to own folder (/{user_id}/*)
   - SELECT: User can view own documents OR admin with kyc.review
   - DELETE: Admin only

   listing-photos:
   - INSERT: Listing owner
   - SELECT: Public (if auction is public)
   - DELETE: Listing owner OR admin

   listing-documents:
   - INSERT: Listing owner
   - SELECT: Listing owner OR winning bidder OR admin
   - DELETE: Listing owner OR admin

================================================================================
MIGRATION STRATEGY
================================================================================

PHASE 1: PREPARATION (No downtime)
1. Export all current data to CSV backups
2. Document all custom RLS policies in current schema
3. Test new schema in staging environment
4. Prepare data transformation scripts

PHASE 2: CREATE NEW SCHEMA (Parallel to old)
1. Create new 3NF normalized tables
2. Create admin system tables
3. Create encryption_keys, encryption_audit_log
4. Set up Supabase Vault
5. Enable pgcrypto extension
6. Create all indexes
7. Create all RPC functions
8. Set up triggers
9. Configure RLS policies

PHASE 3: MIGRATE DATA (Scheduled maintenance)
1. Set application to maintenance mode
2. Run data transformation:
   - Extract unique addresses → addresses table
   - Extract unique brands/models → car_brands, car_models
   - Flatten photo_urls JSONB → listing_photos
   - Flatten features arrays → listing_features
   - Merge users + user_profiles → users
   - Migrate vehicle data → listing_drafts + auctions
3. Encrypt sensitive data:
   - Migrate national_id_number → Supabase Vault
   - Encrypt phone_number → pgcrypto
   - Encrypt KYC photos → Application-level AES-256-GCM
4. Update foreign key references
5. Validate data integrity

PHASE 4: SWITCH OVER
1. Update application code to use new schema
2. Deploy new Flutter app version
3. Switch database connection to new schema
4. Monitor for errors
5. Keep old schema for 7 days (rollback safety)

PHASE 5: CLEANUP
1. Drop old tables (after verification)
2. Reclaim storage space
3. Update documentation
4. Archive old backups

ESTIMATED DOWNTIME: 2-4 hours (for data migration and validation)

================================================================================
IMPLEMENTATION CHECKLIST
================================================================================

DATABASE SETUP:
□ Create Supabase project (production)
□ Enable required extensions: pgcrypto, supabase_vault, pg_cron
□ Create all 51 tables in correct order (addresses first, then users, etc.)
□ Create all indexes (primary, composite, partial, GIN)
□ Create all foreign key constraints
□ Create all CHECK constraints
□ Set up RLS policies for all tables
□ Create all RPC functions (30+ functions)
□ Set up triggers (auto_update_updated_at, counters, audit logging)
□ Create materialized views (auction_stats_by_category, user_activity_summary)
□ Set up scheduled jobs (pg_cron): Dashboard metrics refresh, admin notifications, cleanup
□ Configure storage buckets (kyc-documents, listing-photos, listing-documents, etc.)
□ Set up storage bucket RLS policies

ENCRYPTION SETUP:
□ Generate master encryption key
□ Store master key in Supabase environment secrets
□ Initialize Supabase Vault
□ Create encryption/decryption RPC functions
□ Set up encryption audit logging triggers
□ Test Vault operations (store, retrieve, delete)
□ Test pgcrypto operations (encrypt, decrypt, hash)
□ Test file encryption/decryption in Flutter app

ADMIN SYSTEM SETUP:
□ Create admin roles (5 roles with descriptions)
□ Create admin permissions (all 50+ permissions)
□ Map permissions to roles (admin_role_permissions)
□ Create super_admin user account
□ Test admin login with 2FA
□ Set up admin audit logging
□ Configure admin notification system
□ Set up dashboard metrics refresh job (30-second interval)
□ Test KYC review queue functionality
□ Test payment verification queue
□ Test auction live monitoring
□ Test report generation (PDF, CSV, Excel)

FLUTTER APP INTEGRATION:
□ Update all Supabase datasources to use new schema
□ Implement Vault encryption service (national IDs)
□ Implement pgcrypto service (phone, DOB)
□ Implement file encryption service (KYC photos)
□ Update all domain entities to match new schema
□ Update all repository implementations
□ Implement Realtime subscriptions (bids, chat, notifications)
□ Test all CRUD operations with new schema
□ Test RLS policies (ensure unauthorized access is blocked)
□ Test encryption/decryption flows
□ Performance testing (query response times < 100ms)
□ Load testing (100+ concurrent users)

TESTING:
□ Unit tests for all encryption functions
□ Integration tests for KYC flow (with encryption)
□ Integration tests for auction bidding (realtime)
□ Integration tests for payment verification (admin)
□ Security testing (attempt RLS bypass, SQL injection)
□ Performance testing (database query optimization)
□ Load testing (stress test with 1000+ concurrent auctions)
□ Audit log verification (all admin actions logged)
□ Encryption audit verification (all sensitive data access logged)

DEPLOYMENT:
□ Deploy new schema to production Supabase
□ Migrate data from old schema (scheduled downtime)
□ Deploy new Flutter app version (with new schema)
□ Monitor error logs for 48 hours
□ Verify all features working (KYC, auctions, payments, admin)
□ Verify realtime features working (bids, chat, notifications)
□ Verify encryption working (no plaintext sensitive data)
□ Verify admin system working (dashboard, monitoring, reports)

POST-DEPLOYMENT:
□ Monitor database performance (query times, connection pool)
□ Monitor storage usage (encrypted files, audit logs)
□ Set up automated backups (daily, weekly, monthly)
□ Set up monitoring alerts (Supabase dashboard + external)
□ Document all RLS policies
□ Document all RPC functions
□ Train admin team on new admin system
□ Create user documentation for new features

COMPLIANCE:
□ Data Privacy Impact Assessment (DPIA) for Philippines
□ GDPR compliance verification (if applicable)
□ Data retention policy documentation (7 years for audit logs)
□ Data breach response plan
□ User consent forms for data collection
□ Privacy policy update (include encryption details)
□ Terms of service update

================================================================================
PERFORMANCE OPTIMIZATION
================================================================================

QUERY OPTIMIZATION:
- Use EXPLAIN ANALYZE for all critical queries
- Create indexes on frequently queried columns
- Use partial indexes for status-based queries (WHERE status = 'active')
- Use composite indexes for multi-column filters
- Use GIN indexes for JSONB and array searches
- Use materialized views for heavy reporting queries

CONNECTION POOLING:
- Configure Supabase connection pooling (recommended: max 100 connections)
- Use pgBouncer for connection pooling in production
- Monitor connection usage in Supabase dashboard

CACHING:
- Cache dashboard metrics (admin_dashboard_metrics table, 30s refresh)
- Cache frequently accessed data in Flutter app (in-memory cache)
- Use Redis for session management (if needed at scale)

REALTIME OPTIMIZATION:
- Limit Realtime subscriptions to necessary tables only
- Use filters in subscriptions (WHERE clauses) to reduce payload
- Unsubscribe when leaving screens
- Batch updates to reduce Realtime events

STORAGE OPTIMIZATION:
- Compress images before upload (max 10MB)
- Use WebP format for photos (smaller file size)
- Implement lazy loading for image galleries
- Clean up orphaned files (scheduled job)

DATABASE MAINTENANCE:
- Run VACUUM ANALYZE monthly
- Rebuild indexes quarterly
- Monitor table bloat
- Archive old audit logs (> 7 years) to cold storage

================================================================================
SECURITY BEST PRACTICES
================================================================================

1. NEVER expose encryption keys in source code
2. ALWAYS use RLS policies (default deny, explicit allow)
3. ALWAYS validate user input (prevent SQL injection)
4. ALWAYS use parameterized queries
5. ALWAYS audit admin actions (admin_audit_log)
6. ALWAYS audit encryption access (encryption_audit_log)
7. NEVER store plaintext passwords (use Supabase Auth)
8. ALWAYS use HTTPS for all API calls
9. ALWAYS validate file uploads (check MIME type, file size)
10. ALWAYS sanitize user-generated content (prevent XSS)
11. ALWAYS rotate encryption keys annually
12. ALWAYS backup before schema changes
13. ALWAYS test RLS policies thoroughly
14. ALWAYS enable 2FA for admin accounts
15. ALWAYS monitor for suspicious activity (multiple failed logins, rapid bidding)

================================================================================
SUPPORT & MAINTENANCE
================================================================================

DATABASE MONITORING:
- Supabase dashboard (CPU, memory, storage, connections)
- Custom alerting for critical metrics (connection pool full, slow queries)
- Weekly performance reports
- Monthly security audits

SCHEDULED MAINTENANCE:
- Daily: Database backups, dashboard metrics refresh, admin notifications
- Weekly: Cleanup read notifications, cleanup expired reports
- Monthly: VACUUM ANALYZE, rebuild indexes
- Quarterly: Encryption key rotation check
- Yearly: Rotate encryption keys, archive old audit logs

INCIDENT RESPONSE:
- Data breach: Follow Data Privacy Act 2012 notification requirements
- Database corruption: Restore from latest backup, investigate root cause
- RLS policy breach: Immediate lockdown, audit log review, patch deployment
- Performance degradation: Query optimization, index creation, connection pool adjustment

UPGRADE PATH:
- Supabase version upgrades: Test in staging first, schedule maintenance window
- PostgreSQL version upgrades: Follow Supabase upgrade guide
- Schema changes: Use migrations (never direct ALTER TABLE in production)
- Flutter app updates: Ensure backward compatibility with database schema

================================================================================
END OF IMPLEMENTATION REFERENCE
================================================================================

For detailed implementation of specific components, refer to:
- database_schema.txt (complete table definitions)
- data_encryption_guidelines.txt (encryption implementation)
- admin_system_requirements.txt (admin functionality specification)

All documentation maintained by: AutoBid Development Team
Last Updated: 2025-12-07
