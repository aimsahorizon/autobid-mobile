================================================================================
NEXT.JS ADMIN PORTAL - IMPLEMENTATION GUIDE
================================================================================
Version: 1.0
Purpose: Guide for building the Next.js web admin portal for AutoBid
Target Stack: Next.js + Supabase + TypeScript + Tailwind CSS
================================================================================

OVERVIEW:
This is a unified admin portal for all admin roles (super_admin, operations_admin,
finance_admin, support_admin, moderator). All roles use the same Next.js application
with role-based UI rendering and API access control.

================================================================================
SECTION 1: ARCHITECTURE
================================================================================

TECH STACK:
- Next.js 14+ (App Router)
- Supabase Client (authentication + database)
- TypeScript (strict mode)
- Tailwind CSS + shadcn/ui (components)
- Recharts (dashboard charts)
- React Query / SWR (data fetching)
- Zustand / Redux (state management)

PROJECT STRUCTURE:
```
nextjs-admin-portal/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx (minimal layout)
â”‚   â”œâ”€â”€ (dashboard)/
â”‚   â”‚   â”œâ”€â”€ layout.tsx (sidebar, header, role-based navigation)
â”‚   â”‚   â”œâ”€â”€ page.tsx (dashboard home - role-specific)
â”‚   â”‚   â”œâ”€â”€ auctions/
â”‚   â”‚   â”‚   â”œâ”€â”€ monitor/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx (Moderator access âœ“)
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx (auction detail)
â”‚   â”‚   â”œâ”€â”€ kyc/
â”‚   â”‚   â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx (Operations Admin only)
â”‚   â”‚   â”‚   â””â”€â”€ [userId]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx (KYC review detail)
â”‚   â”‚   â”œâ”€â”€ payments/
â”‚   â”‚   â”‚   â”œâ”€â”€ verify/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx (Finance Admin only)
â”‚   â”‚   â”‚   â””â”€â”€ refunds/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx (Finance Admin only)
â”‚   â”‚   â”œâ”€â”€ support/
â”‚   â”‚   â”‚   â”œâ”€â”€ tickets/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx (Support Admin + Operations Admin)
â”‚   â”‚   â”‚   â””â”€â”€ [ticketId]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx (ticket detail)
â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx (Operations Admin, read-only for Support)
â”‚   â”‚   â”‚   â””â”€â”€ [userId]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx (user profile detail)
â”‚   â”‚   â”œâ”€â”€ reports/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx (Finance Admin + Super Admin)
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx (Super Admin only)
â”‚   â”‚   â””â”€â”€ audit-logs/
â”‚   â”‚       â””â”€â”€ page.tsx (Super Admin only)
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ auth/
â”‚       â”‚   â””â”€â”€ callback/
â”‚       â”‚       â””â”€â”€ route.ts (Supabase auth callback)
â”‚       â””â”€â”€ admin/
â”‚           â”œâ”€â”€ dashboard-metrics/
â”‚           â”‚   â””â”€â”€ route.ts (GET - all admins)
â”‚           â”œâ”€â”€ kyc/
â”‚           â”‚   â”œâ”€â”€ queue/
â”‚           â”‚   â”‚   â””â”€â”€ route.ts (GET/POST - ops_admin)
â”‚           â”‚   â””â”€â”€ [userId]/
â”‚           â”‚       â””â”€â”€ route.ts (GET/PATCH - ops_admin)
â”‚           â”œâ”€â”€ auctions/
â”‚           â”‚   â”œâ”€â”€ monitor/
â”‚           â”‚   â”‚   â””â”€â”€ route.ts (GET - moderator âœ“)
â”‚           â”‚   â””â”€â”€ [auctionId]/
â”‚           â”‚       â””â”€â”€ route.ts (GET/PATCH - moderator âœ“)
â”‚           â”œâ”€â”€ payments/
â”‚           â”‚   â””â”€â”€ verify/
â”‚           â”‚       â””â”€â”€ route.ts (POST - finance_admin)
â”‚           â””â”€â”€ audit-logs/
â”‚               â””â”€â”€ route.ts (GET - super_admin)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ sidebar.tsx (role-based navigation)
â”‚   â”‚   â”œâ”€â”€ header.tsx
â”‚   â”‚   â”œâ”€â”€ metrics-card.tsx
â”‚   â”‚   â””â”€â”€ charts/
â”‚   â”‚       â”œâ”€â”€ revenue-chart.tsx
â”‚   â”‚       â”œâ”€â”€ user-growth-chart.tsx
â”‚   â”‚       â””â”€â”€ auction-activity-chart.tsx
â”‚   â”œâ”€â”€ kyc/
â”‚   â”‚   â”œâ”€â”€ kyc-queue-table.tsx
â”‚   â”‚   â”œâ”€â”€ kyc-review-form.tsx
â”‚   â”‚   â””â”€â”€ document-viewer.tsx (zoomable image viewer)
â”‚   â”œâ”€â”€ auctions/
â”‚   â”‚   â”œâ”€â”€ auction-monitor-table.tsx (Moderator âœ“)
â”‚   â”‚   â”œâ”€â”€ live-bid-stream.tsx (Moderator âœ“)
â”‚   â”‚   â””â”€â”€ auction-timeline.tsx
â”‚   â”œâ”€â”€ payments/
â”‚   â”‚   â”œâ”€â”€ payment-queue-table.tsx
â”‚   â”‚   â””â”€â”€ payment-verification-form.tsx
â”‚   â””â”€â”€ ui/ (shadcn/ui components)
â”‚       â”œâ”€â”€ button.tsx
â”‚       â”œâ”€â”€ card.tsx
â”‚       â”œâ”€â”€ table.tsx
â”‚       â”œâ”€â”€ dialog.tsx
â”‚       â””â”€â”€ ...
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts (browser client)
â”‚   â”‚   â”œâ”€â”€ server.ts (server-side client)
â”‚   â”‚   â””â”€â”€ middleware.ts (auth middleware)
â”‚   â”œâ”€â”€ permissions.ts (RBAC helper functions)
â”‚   â”œâ”€â”€ types.ts (TypeScript types from DB)
â”‚   â””â”€â”€ utils.ts
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAdmin.ts (current admin user + role)
â”‚   â”œâ”€â”€ usePermissions.ts (check permissions)
â”‚   â””â”€â”€ useDashboardMetrics.ts (real-time metrics)
â””â”€â”€ middleware.ts (Next.js middleware for auth)
```

================================================================================
SECTION 2: AUTHENTICATION & AUTHORIZATION
================================================================================

AUTHENTICATION (Supabase Auth):
```typescript
// lib/supabase/client.ts
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'

export const supabase = createClientComponentClient()

// Login function
export async function signInAdmin(email: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  })

  if (error) throw error

  // Verify user is in admin_users table
  const { data: adminUser } = await supabase
    .from('admin_users')
    .select('id, username, email, full_name, role_id, admin_roles(role_name)')
    .eq('id', data.user.id)
    .single()

  if (!adminUser) {
    await supabase.auth.signOut()
    throw new Error('User is not authorized as admin')
  }

  return adminUser
}
```

ROLE-BASED ACCESS CONTROL:
```typescript
// lib/permissions.ts
export type AdminRole = 'super_admin' | 'moderator'

export type Permission =
  | 'dashboard.view'
  | 'kyc.review' | 'kyc.approve'
  | 'auction.monitor' | 'auction.cancel' | 'auction.flag'
  | 'payment.verify' | 'payment.refund'
  | 'user.view' | 'user.edit' | 'user.suspend'
  | 'support.view' | 'support.reply'
  | 'reports.financial' | 'reports.generate'
  | 'system.config'
  | 'audit.view'

// Permission matrix (matches admin_system_requirements.txt)
const ROLE_PERMISSIONS: Record<AdminRole, Permission[]> = {
  super_admin: [
    'dashboard.view', 'kyc.review', 'kyc.approve', 'auction.monitor',
    'auction.cancel', 'auction.flag', 'payment.verify', 'payment.refund',
    'user.view', 'user.edit', 'user.suspend', 'support.view', 'support.reply',
    'reports.financial', 'reports.generate', 'system.config', 'audit.view'
  ],
  moderator: [
    'dashboard.view', 'auction.monitor', 'auction.flag'
  ],
}

export function hasPermission(role: AdminRole, permission: Permission): boolean {
  return ROLE_PERMISSIONS[role]?.includes(permission) ?? false
}

export function canAccessRoute(role: AdminRole, route: string): boolean {
  const routePermissionMap: Record<string, Permission> = {
    '/kyc': 'kyc.review',
    '/payments': 'payment.verify',
    '/auctions/monitor': 'auction.monitor', // Moderator âœ“
    '/support': 'support.view',
    '/reports': 'reports.financial',
    '/settings': 'system.config',
    '/audit-logs': 'audit.view',
  }

  const requiredPermission = routePermissionMap[route]
  if (!requiredPermission) return true // Public route

  return hasPermission(role, requiredPermission)
}
```

MIDDLEWARE (Route Protection):
```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })

  const { data: { session } } = await supabase.auth.getSession()

  // Redirect to login if not authenticated
  if (!session && !req.nextUrl.pathname.startsWith('/login')) {
    return NextResponse.redirect(new URL('/login', req.url))
  }

  // Check if user is admin
  if (session) {
    const { data: adminUser } = await supabase
      .from('admin_users')
      .select('role_id, admin_roles(role_name)')
      .eq('id', session.user.id)
      .single()

    if (!adminUser) {
      await supabase.auth.signOut()
      return NextResponse.redirect(new URL('/login', req.url))
    }

    // Role-based route protection
    const role = adminUser.admin_roles.role_name as AdminRole
    const path = req.nextUrl.pathname

    if (!canAccessRoute(role, path)) {
      return NextResponse.redirect(new URL('/unauthorized', req.url))
    }
  }

  return res
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
}
```

================================================================================
SECTION 3: ROLE-SPECIFIC DASHBOARDS
================================================================================

MODERATOR DASHBOARD (Primary Use Case):
```typescript
// app/(dashboard)/page.tsx
'use client'

import { useAdmin } from '@/hooks/useAdmin'
import { ModeratorDashboard } from '@/components/dashboard/moderator-dashboard'
import { OperationsDashboard } from '@/components/dashboard/operations-dashboard'
import { FinanceDashboard } from '@/components/dashboard/finance-dashboard'
// ... other role dashboards

export default function DashboardPage() {
  const { admin, role } = useAdmin()

  // Render role-specific dashboard
  switch (role) {
    case 'moderator':
      return <ModeratorDashboard admin={admin} />
    case 'super_admin':
      return <SuperAdminDashboard admin={admin} />
    default:
      return <UnauthorizedPage />
  }
}
```

MODERATOR DASHBOARD COMPONENT:
```typescript
// components/dashboard/moderator-dashboard.tsx
'use client'

import { useQuery } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase/client'
import { MetricsCard } from './metrics-card'
import { AuctionMonitorTable } from '@/components/auctions/auction-monitor-table'
import { RecentAlerts } from './recent-alerts'

export function ModeratorDashboard({ admin }) {
  const { data: metrics } = useQuery({
    queryKey: ['moderator-metrics'],
    queryFn: async () => {
      const { data } = await supabase
        .from('admin_dashboard_metrics')
        .select('*')
        .order('metric_date', { ascending: false })
        .limit(1)
        .single()
      return data
    },
    refetchInterval: 30000, // Refresh every 30 seconds
  })

  const { data: activeAuctions } = useQuery({
    queryKey: ['active-auctions'],
    queryFn: async () => {
      const { data } = await supabase
        .from('admin_auction_monitoring')
        .select(`
          *,
          auctions (
            id,
            title,
            current_highest_bid,
            end_time
          )
        `)
        .order('is_final_two_minutes', { ascending: false })
        .order('is_flagged', { ascending: false })
      return data
    },
    refetchInterval: 10000, // Refresh every 10 seconds
  })

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">Moderator Dashboard</h1>

      {/* Key Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <MetricsCard
          title="Active Auctions"
          value={metrics?.active_auctions ?? 0}
          icon="ğŸ·ï¸"
        />
        <MetricsCard
          title="Final 2 Minutes"
          value={activeAuctions?.filter(a => a.is_final_two_minutes).length ?? 0}
          icon="ğŸ”´"
          variant="danger"
        />
        <MetricsCard
          title="Flagged Auctions"
          value={activeAuctions?.filter(a => a.is_flagged).length ?? 0}
          icon="âš ï¸"
          variant="warning"
        />
        <MetricsCard
          title="Active Bidders"
          value={metrics?.active_bidders ?? 0}
          icon="ğŸ‘¥"
        />
      </div>

      {/* Recent Alerts */}
      <RecentAlerts adminId={admin.id} />

      {/* Live Auction Monitoring */}
      <div>
        <h2 className="text-2xl font-semibold mb-4">Live Auction Monitoring</h2>
        <AuctionMonitorTable auctions={activeAuctions ?? []} />
      </div>
    </div>
  )
}
```

AUCTION MONITORING PAGE (Moderator Access):
```typescript
// app/(dashboard)/auctions/monitor/page.tsx
'use client'

import { useState } from 'react'
import { useQuery } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase/client'
import { AuctionMonitorTable } from '@/components/auctions/auction-monitor-table'
import { AuctionFilters } from '@/components/auctions/auction-filters'

export default function AuctionMonitorPage() {
  const [filters, setFilters] = useState({
    status: 'all',
    category: 'all',
    flagged: false,
  })

  const { data: auctions, refetch } = useQuery({
    queryKey: ['auction-monitor', filters],
    queryFn: async () => {
      let query = supabase
        .from('admin_auction_monitoring')
        .select(`
          *,
          auctions (
            id,
            title,
            category,
            current_highest_bid,
            bid_count,
            end_time,
            status
          )
        `)

      if (filters.flagged) {
        query = query.eq('is_flagged', true)
      }

      const { data } = await query
        .order('is_final_two_minutes', { ascending: false })
        .order('time_remaining_seconds', { ascending: true })

      return data
    },
    refetchInterval: 10000, // Auto-refresh every 10 seconds
  })

  // Subscribe to real-time updates
  useEffect(() => {
    const channel = supabase
      .channel('auction-monitoring')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'admin_auction_monitoring',
        filter: 'is_final_two_minutes=eq.true'
      }, () => {
        refetch() // Refetch when final 2 minutes triggered
      })
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [refetch])

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">Live Auction Monitoring</h1>

      <AuctionFilters filters={filters} onChange={setFilters} />

      <AuctionMonitorTable
        auctions={auctions ?? []}
        onFlag={handleFlag}
        onViewDetails={handleViewDetails}
      />
    </div>
  )

  async function handleFlag(auctionId: string, reason: string) {
    await supabase
      .from('admin_auction_monitoring')
      .update({
        is_flagged: true,
        flag_reason: reason,
        monitored_by: admin.id
      })
      .eq('auction_id', auctionId)

    // Log audit trail
    await supabase
      .from('admin_audit_log')
      .insert({
        admin_id: admin.id,
        action: 'auction.flagged',
        resource_type: 'auction',
        resource_id: auctionId,
        details: { reason },
      })

    refetch()
  }
}
```

================================================================================
SECTION 4: REAL-TIME FEATURES
================================================================================

REAL-TIME AUCTION MONITORING (Moderator):
```typescript
// hooks/useLiveAuctionMonitoring.ts
import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase/client'

export function useLiveAuctionMonitoring() {
  const [finalTwoMinuteAuctions, setFinalTwoMinuteAuctions] = useState<any[]>([])
  const [flaggedAuctions, setFlaggedAuctions] = useState<any[]>([])

  useEffect(() => {
    // Subscribe to final 2-minute alerts
    const channel = supabase
      .channel('auction-alerts')
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'admin_auction_monitoring',
        filter: 'is_final_two_minutes=eq.true'
      }, (payload) => {
        // Show browser notification
        if (Notification.permission === 'granted') {
          new Notification('ğŸ”´ Auction Ending Soon!', {
            body: `Auction ${payload.new.auction_id} is in the final 2 minutes`,
            icon: '/auction-icon.png',
          })
        }

        // Play audio alert
        const audio = new Audio('/alert.mp3')
        audio.play()

        // Update state
        setFinalTwoMinuteAuctions(prev => [...prev, payload.new])
      })
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'admin_auction_monitoring',
        filter: 'is_flagged=eq.true'
      }, (payload) => {
        setFlaggedAuctions(prev => [...prev, payload.new])
      })
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [])

  return { finalTwoMinuteAuctions, flaggedAuctions }
}
```

REAL-TIME BID STREAM (Moderator):
```typescript
// components/auctions/live-bid-stream.tsx
'use client'

import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase/client'

export function LiveBidStream({ auctionId }: { auctionId: string }) {
  const [bids, setBids] = useState<any[]>([])

  useEffect(() => {
    // Fetch initial bids
    supabase
      .from('bids')
      .select('*')
      .eq('auction_id', auctionId)
      .order('created_at', { ascending: false })
      .limit(50)
      .then(({ data }) => setBids(data ?? []))

    // Subscribe to new bids
    const channel = supabase
      .channel(`auction-${auctionId}-bids`)
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'bids',
        filter: `auction_id=eq.${auctionId}`
      }, (payload) => {
        setBids(prev => [payload.new, ...prev])
      })
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [auctionId])

  return (
    <div className="bg-white rounded-lg shadow p-4 max-h-96 overflow-y-auto">
      <h3 className="text-lg font-semibold mb-4">Live Bid Stream</h3>
      <div className="space-y-2">
        {bids.map((bid) => (
          <div key={bid.id} className="flex justify-between items-center border-b pb-2">
            <div>
              <span className="font-medium">Bidder #{bid.bidder_number}</span>
              <span className="text-sm text-gray-500 ml-2">
                {bid.is_auto_bid ? 'ğŸ¤– Auto-bid' : 'ğŸ‘¤ Manual'}
              </span>
            </div>
            <div className="text-right">
              <div className="font-bold">â‚±{bid.amount.toLocaleString()}</div>
              <div className="text-xs text-gray-500">
                {new Date(bid.created_at).toLocaleTimeString()}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}
```

================================================================================
SECTION 5: API ROUTES (Server-Side)
================================================================================

DASHBOARD METRICS API:
```typescript
// app/api/admin/dashboard-metrics/route.ts
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const supabase = createRouteHandlerClient({ cookies })

  // Verify admin authentication
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // Verify user is admin
  const { data: adminUser } = await supabase
    .from('admin_users')
    .select('id')
    .eq('id', session.user.id)
    .single()

  if (!adminUser) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }

  // Fetch latest dashboard metrics
  const { data: metrics, error } = await supabase
    .from('admin_dashboard_metrics')
    .select('*')
    .order('metric_date', { ascending: false })
    .limit(1)
    .single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json(metrics)
}
```

AUCTION MONITORING API (Moderator Access):
```typescript
// app/api/admin/auctions/monitor/route.ts
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextResponse } from 'next/server'
import { hasPermission } from '@/lib/permissions'

export async function GET(request: Request) {
  const supabase = createRouteHandlerClient({ cookies })

  // Verify admin authentication
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // Verify user is admin with auction.monitor permission
  const { data: adminUser } = await supabase
    .from('admin_users')
    .select('id, admin_roles(role_name)')
    .eq('id', session.user.id)
    .single()

  if (!adminUser || !hasPermission(adminUser.admin_roles.role_name, 'auction.monitor')) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }

  // Fetch auction monitoring data
  const { data: auctions, error } = await supabase
    .from('admin_auction_monitoring')
    .select(`
      *,
      auctions (
        id,
        title,
        category,
        current_highest_bid,
        bid_count,
        end_time,
        status
      )
    `)
    .order('is_final_two_minutes', { ascending: false })
    .order('time_remaining_seconds', { ascending: true })

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json(auctions)
}

export async function PATCH(request: Request) {
  const supabase = createRouteHandlerClient({ cookies })
  const body = await request.json()

  // Verify admin authentication
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // Verify user is admin with auction.flag permission
  const { data: adminUser } = await supabase
    .from('admin_users')
    .select('id, admin_roles(role_name)')
    .eq('id', session.user.id)
    .single()

  if (!adminUser || !hasPermission(adminUser.admin_roles.role_name, 'auction.flag')) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }

  // Flag auction
  const { error } = await supabase
    .from('admin_auction_monitoring')
    .update({
      is_flagged: true,
      flag_reason: body.reason,
      monitored_by: session.user.id,
    })
    .eq('auction_id', body.auctionId)

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  // Log audit trail
  await supabase
    .from('admin_audit_log')
    .insert({
      admin_id: session.user.id,
      action: 'auction.flagged',
      resource_type: 'auction',
      resource_id: body.auctionId,
      details: { reason: body.reason },
    })

  return NextResponse.json({ success: true })
}
```

================================================================================
SECTION 6: SIDEBAR NAVIGATION (Role-Based)
================================================================================

```typescript
// components/dashboard/sidebar.tsx
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { useAdmin } from '@/hooks/useAdmin'
import { hasPermission } from '@/lib/permissions'

export function Sidebar() {
  const pathname = usePathname()
  const { admin, role } = useAdmin()

  const navItems = [
    {
      label: 'Dashboard',
      href: '/',
      icon: 'ğŸ“Š',
      permission: 'dashboard.view',
    },
    {
      label: 'Auction Monitoring',
      href: '/auctions/monitor',
      icon: 'ğŸ·ï¸',
      permission: 'auction.monitor', // Moderator âœ“
    },
    {
      label: 'KYC Review',
      href: '/kyc/queue',
      icon: 'ğŸ†”',
      permission: 'kyc.review', // Moderator âœ—
    },
    {
      label: 'Payment Verification',
      href: '/payments/verify',
      icon: 'ğŸ’³',
      permission: 'payment.verify', // Moderator âœ—
    },
    {
      label: 'Support Tickets',
      href: '/support/tickets',
      icon: 'ğŸ«',
      permission: 'support.view', // Moderator âœ—
    },
    {
      label: 'User Management',
      href: '/users',
      icon: 'ğŸ‘¥',
      permission: 'user.view', // Moderator âœ—
    },
    {
      label: 'Reports',
      href: '/reports',
      icon: 'ğŸ“ˆ',
      permission: 'reports.financial', // Moderator âœ—
    },
    {
      label: 'System Settings',
      href: '/settings',
      icon: 'âš™ï¸',
      permission: 'system.config', // Moderator âœ—
    },
    {
      label: 'Audit Logs',
      href: '/audit-logs',
      icon: 'ğŸ“œ',
      permission: 'audit.view', // Moderator âœ—
    },
  ]

  return (
    <aside className="w-64 bg-gray-900 text-white min-h-screen p-4">
      <div className="mb-8">
        <h1 className="text-2xl font-bold">AutoBid Admin</h1>
        <p className="text-sm text-gray-400">{admin.full_name}</p>
        <p className="text-xs text-gray-500 capitalize">{role.replace('_', ' ')}</p>
      </div>

      <nav className="space-y-2">
        {navItems
          .filter(item => hasPermission(role, item.permission))
          .map(item => (
            <Link
              key={item.href}
              href={item.href}
              className={`
                flex items-center gap-3 px-4 py-2 rounded-lg transition
                ${pathname === item.href
                  ? 'bg-blue-600 text-white'
                  : 'hover:bg-gray-800'
                }
              `}
            >
              <span className="text-xl">{item.icon}</span>
              <span>{item.label}</span>
            </Link>
          ))}
      </nav>
    </aside>
  )
}
```

**MODERATOR SEES:**
- âœ… Dashboard
- âœ… Auction Monitoring
- âŒ KYC Review (hidden)
- âŒ Payment Verification (hidden)
- âŒ Support Tickets (hidden)
- âŒ User Management (hidden)
- âŒ Reports (hidden)
- âŒ System Settings (hidden)
- âŒ Audit Logs (hidden)

================================================================================
SECTION 7: DEPLOYMENT
================================================================================

ENVIRONMENT VARIABLES (.env.local):
```bash
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key (server-side only)
```

BUILD & DEPLOY:
```bash
# Install dependencies
npm install

# Run development server
npm run dev

# Build for production
npm run build

# Deploy to Vercel (recommended for Next.js)
vercel deploy
```

VERCEL DEPLOYMENT:
1. Connect GitHub repository to Vercel
2. Set environment variables in Vercel dashboard
3. Deploy (auto-deploys on git push to main)

================================================================================
SECTION 8: SECURITY BEST PRACTICES
================================================================================

1. âœ… NEVER use SUPABASE_SERVICE_ROLE_KEY on client-side
2. âœ… ALWAYS verify admin role on server-side API routes
3. âœ… ALWAYS check permissions before rendering UI components
4. âœ… ALWAYS use RLS policies in Supabase (defense in depth)
5. âœ… ALWAYS log admin actions to admin_audit_log
6. âœ… ALWAYS validate input (use Zod for schema validation)
7. âœ… ALWAYS use HTTPS in production
8. âœ… ALWAYS enable 2FA for admin accounts
9. âœ… ALWAYS set session timeout (30 minutes recommended)
10. âœ… ALWAYS use Content Security Policy (CSP) headers

================================================================================
END OF NEXT.JS ADMIN PORTAL GUIDE
================================================================================

For database schema and admin requirements, refer to:
- memory/database_schema.txt
- memory/admin_system_requirements.txt
- memory/IMPLEMENTATION_REFERENCE.txt
